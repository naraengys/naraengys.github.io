<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>나라이엔지 작업현황</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=eb47ba5aac6adcee49680ecf6d6c9197&libraries=services"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f8fafd;
      margin: 0; padding: 0;
      text-align: center;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 16px;
    }
    .title {
      font-size: 2rem;
      font-weight: bold;
      margin-top: 24px;
      margin-bottom: 16px;
      letter-spacing: 2px;
      color: #32428b;
    }
    nav {
      background: #4a74d2;
      padding: 12px 0;
      margin-bottom: 20px;
    }
    nav ul {
      display: flex;
      justify-content: center;
      gap: 12px;
      list-style: none;
      padding: 0; margin: 0;
      flex-wrap: wrap;
    }
    nav a {
      color: #fff;
      background: #3451a1;
      padding: 10px 18px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 16px;
      font-weight: 500;
      transition: background 0.2s;
      display: block;
    }
    nav a:hover { background: #638cf4; }
    h2 {
      font-size: 1.5rem;
      margin: 30px 0 18px 0;
      font-weight: bold;
      letter-spacing: 1px;
    }
    #map {
      width: 100%;
      max-width: 760px;
      height: 400px;
      margin: 0 auto 30px auto;
      border: 2px solid #c6d0e1;
      border-radius: 12px;
      background: #eef1f7;
    }
    #address-table-container {
      margin: 0 auto;
      max-width: 760px;
      margin-bottom: 40px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      font-size: 16px;
      margin-top: 10px;
      box-shadow: 0 2px 8px #dde4ed40;
    }
    th, td {
      padding: 8px 4px;
      border-bottom: 1px solid #e1e5ef;
      text-align: center;
    }
    th {
      background: #4a74d2;
      color: #fff;
      font-weight: bold;
    }
    tr:last-child td { border-bottom: none; }
    @media (max-width: 700px) {
      .container, #map, #address-table-container, table { max-width: 100vw; }
      #map { height: 350px; }
      .title { font-size: 1.4rem; }
      h2 { font-size: 1.1rem; }
      table { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">나라이엔지 작업현황</div>
    <nav>
      <ul>
        <li><a href="index.html">작업내용</a></li>
        <li><a href="location.html">작업주소</a></li>
        <li><a href="caution.html">주의사항</a></li>
        <li><a href="map.html">지도보기</a></li>
      </ul>
    </nav>

    <h2>작업 위치 지도</h2>
    <div id="map"></div>

    <div id="address-table-container">
      <table id="address-table">
        <thead>
          <tr>
            <th>맞춤번호</th>
            <th>주소</th>
            <th>비고</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // 지도 초기화
    let map;
    let geocoder;
    window.onload = function () {
      map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(35.336, 129.038),
        level: 6
      });
      geocoder = new kakao.maps.services.Geocoder();

      Papa.parse("data/작업주소.csv", {
        download: true,
        header: true,
        complete: function (results) {
          // 지도 마커는 변환 성공한 주소만!
          results.data.forEach(row => {
            const address = row["주소"];
            const info = row["비고"] || "";
            const label = row["맞춤번호"] || "N";
            if (address && label) {
              geocoder.addressSearch(address, function (result, status) {
                if (status === kakao.maps.services.Status.OK) {
                  const coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                  // 숫자 원형 마커 커스텀 오버레이 (기본 마커 대신)
                  const content = `
                    <div style="
                      background:#f3f6fb;
                      color:#253271;
                      border:2px solid #4a74d2;
                      border-radius: 50%;
                      width:38px; height:38px;
                      line-height:38px;
                      font-weight:bold;
                      font-size:17px;
                      text-align:center;
                      box-shadow: 1px 3px 10px #aac1e61c;
                      ">
                      ${label}
                    </div>
                  `;
                  const overlay = new kakao.maps.CustomOverlay({
                    content: content,
                    position: coords,
                    yAnchor: 0.5,
                  });

                  overlay.setMap(map);

                  // 클릭시 팝업(InfoWindow)
                  const infowindow = new kakao.maps.InfoWindow({
                    content: `
                      <div style="background:#fff; padding:12px 10px 10px 10px; border-radius:8px; min-width:180px; min-height:40px; font-size:15px; box-shadow:0 3px 15px #aaa4;">
                        <b>맞춤번호:</b> ${label}<br>
                        <b>주소:</b> ${address}<br>
                        <b>비고:</b> ${info}<br>
                        <a href="https://map.kakao.com/?eName=${encodeURIComponent(address)}" target="_blank">
                          <button style="margin-top:6px; background:#4a74d2;color:#fff;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;">길찾기</button>
                        </a>
                      </div>
                    `,
                  });

                  kakao.maps.event.addListener(overlay, 'click', function () {
                    infowindow.setPosition(coords);
                    infowindow.open(map);
                  });
                }
              });
            }
          });

          // ----- 지도 아래 표 -----
          // 맞춤번호 오름차순 정렬
          const sorted = results.data.slice().sort((a, b) => {
            // 숫자가 아닌 경우(N 등)는 999로 취급하여 맨 뒤로
            const numA = Number(a["맞춤번호"]) || 999;
            const numB = Number(b["맞춤번호"]) || 999;
            return numA - numB;
          });
          // 표 내용
          let tbodyHTML = "";
          sorted.forEach(row => {
            tbodyHTML += `
              <tr>
                <td>${row["맞춤번호"] || "N"}</td>
                <td>${row["주소"] || ""}</td>
                <td>${row["비고"] || ""}</td>
              </tr>
            `;
          });
          document.querySelector("#address-table tbody").innerHTML = tbodyHTML;
        }
      });
    };
  </script>
</body>
</html>
